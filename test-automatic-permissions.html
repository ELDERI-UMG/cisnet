<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Permisos Autom√°ticos - CISNET</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #bee5eb;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-running {
            background: #fff3cd;
            color: #856404;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .test-credentials {
            background: #e7f1ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Permisos Autom√°ticos Google Drive</h1>

        <div class="test-credentials">
            <h3>üìã Credenciales de Prueba</h3>
            <p><strong>Email:</strong> demo@example.com</p>
            <p><strong>Password:</strong> 123456</p>
            <p><strong>Token:</strong> Se genera autom√°ticamente al hacer login</p>
        </div>

        <!-- Test 1: Verificar estado del servidor -->
        <div class="test-section">
            <h3>üîç Test 1: Estado del Servidor</h3>
            <button class="btn" onclick="testServerStatus()">Verificar Servidor</button>
            <div id="serverResult" class="result"></div>
        </div>

        <!-- Test 2: Login autom√°tico -->
        <div class="test-section">
            <h3>üîê Test 2: Login Autom√°tico</h3>
            <button class="btn" onclick="performLogin()">Login con demo@example.com</button>
            <div id="loginResult" class="result"></div>
        </div>

        <!-- Test 3: Simular compra -->
        <div class="test-section">
            <h3>üõí Test 3: Simular Compra</h3>
            <select id="productSelect">
                <option value="7">Microsoft Office 365</option>
                <option value="8">Adobe Photoshop</option>
                <option value="9">Visual Studio Code</option>
                <option value="10">Windows 11 Pro</option>
            </select>
            <button class="btn btn-success" onclick="simulatePurchase()">Simular Compra</button>
            <div id="purchaseResult" class="result"></div>
        </div>

        <!-- Test 4: Verificar permisos autom√°ticos -->
        <div class="test-section">
            <h3>üîë Test 4: Verificar Permisos Autom√°ticos</h3>
            <button class="btn" onclick="checkPermissions()">Verificar Permisos</button>
            <div id="permissionsResult" class="result"></div>
        </div>

        <!-- Test 5: Probar descarga -->
        <div class="test-section">
            <h3>üìÅ Test 5: Probar URL de Descarga</h3>
            <button class="btn" onclick="testDownload()">Obtener URL de Descarga</button>
            <div id="downloadResult" class="result"></div>
        </div>

        <!-- Test 6: Verificar base de datos -->
        <div class="test-section">
            <h3>üíæ Test 6: Estado de Base de Datos</h3>
            <button class="btn" onclick="checkDatabase()">Verificar BD</button>
            <div id="databaseResult" class="result"></div>
        </div>

        <!-- Test completo -->
        <div class="test-section">
            <h3>üöÄ Test Completo</h3>
            <button class="btn btn-success" onclick="runCompleteTest()">Ejecutar Todos los Tests</button>
            <div id="completeResult" class="result"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let testUserId = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }

        async function testServerStatus() {
            showResult('serverResult', 'Verificando servidor...', 'info');

            try {
                const response = await fetch('http://localhost:3000/health');
                const data = await response.json();

                if (data.status === 'OK') {
                    showResult('serverResult',
                        `‚úÖ Servidor funcionando correctamente\n` +
                        `Timestamp: ${data.timestamp}\n` +
                        `Mensaje: ${data.message}`, 'success');
                } else {
                    throw new Error('Servidor no responde correctamente');
                }
            } catch (error) {
                showResult('serverResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function performLogin() {
            showResult('loginResult', 'Realizando login...', 'info');

            try {
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'demo@example.com',
                        password: '123456'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    testUserId = data.user.id;

                    showResult('loginResult',
                        `‚úÖ Login exitoso\n` +
                        `User ID: ${data.user.id}\n` +
                        `Email: ${data.user.email}\n` +
                        `Token: ${data.token.substring(0, 20)}...`, 'success');
                } else {
                    throw new Error(data.error || 'Error en login');
                }
            } catch (error) {
                showResult('loginResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function simulatePurchase() {
            if (!authToken) {
                showResult('purchaseResult', '‚ùå Debes hacer login primero', 'error');
                return;
            }

            const productId = document.getElementById('productSelect').value;
            showResult('purchaseResult', `Simulando compra del producto ${productId}...`, 'info');

            try {
                const response = await fetch('http://localhost:3000/api/purchases/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        productIds: [parseInt(productId)],
                        totalAmount: 99.99
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showResult('purchaseResult',
                        `‚úÖ Compra exitosa\n` +
                        `Order ID: ${data.orderId}\n` +
                        `Mensaje: ${data.message}\n` +
                        `Nota: ${data.note}`, 'success');
                } else {
                    throw new Error(data.error || 'Error en compra');
                }
            } catch (error) {
                showResult('purchaseResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function checkPermissions() {
            showResult('permissionsResult', 'Verificando permisos pendientes...', 'info');

            try {
                const response = await fetch('http://localhost:3000/api/purchases/pending-permissions');
                const data = await response.json();

                if (data.success) {
                    const pendingCount = data.data.filter(p => !p.permission_granted).length;
                    const grantedCount = data.data.filter(p => p.permission_granted).length;

                    showResult('permissionsResult',
                        `‚úÖ Permisos verificados\n` +
                        `Total: ${data.data.length}\n` +
                        `Pendientes: ${pendingCount}\n` +
                        `Otorgados: ${grantedCount}\n\n` +
                        `√öltimos permisos:\n` +
                        data.data.slice(-3).map(p =>
                            `- ${p.user_email}: ${p.product_name} (${p.permission_granted ? 'Otorgado' : 'Pendiente'})`
                        ).join('\n'), 'success');
                } else {
                    throw new Error(data.error || 'Error verificando permisos');
                }
            } catch (error) {
                showResult('permissionsResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testDownload() {
            if (!authToken) {
                showResult('downloadResult', '‚ùå Debes hacer login primero', 'error');
                return;
            }

            const productId = document.getElementById('productSelect').value;
            showResult('downloadResult', `Obteniendo URL de descarga para producto ${productId}...`, 'info');

            try {
                const response = await fetch('http://localhost:3000/api/purchases/get-download-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        productId: parseInt(productId)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showResult('downloadResult',
                        `‚úÖ URL de descarga obtenida\n` +
                        `Archivo: ${data.fileName || 'N/A'}\n` +
                        `URL: ${data.downloadUrl}\n` +
                        `Mensaje: ${data.message || 'N/A'}\n` +
                        `File ID: ${data.fileId || 'N/A'}`, 'success');
                } else {
                    showResult('downloadResult',
                        `‚ö†Ô∏è ${data.error}\n` +
                        `Status: ${data.status || 'N/A'}\n` +
                        `Email: ${data.userEmail || 'N/A'}`, 'error');
                }
            } catch (error) {
                showResult('downloadResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function checkDatabase() {
            showResult('databaseResult', 'Verificando estado de la base de datos...', 'info');

            try {
                // Verificar que el servidor responda
                const healthResponse = await fetch('http://localhost:3000/health');
                const healthData = await healthResponse.json();

                // Verificar permisos
                const permResponse = await fetch('http://localhost:3000/api/purchases/pending-permissions');
                const permData = await permResponse.json();

                showResult('databaseResult',
                    `‚úÖ Base de datos funcionando\n` +
                    `Servidor: ${healthData.status}\n` +
                    `Permisos en BD: ${permData.success ? permData.data.length : 'Error'}\n` +
                    `Timestamp: ${new Date().toLocaleString()}`, 'success');

            } catch (error) {
                showResult('databaseResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            showResult('completeResult', 'Ejecutando test completo...', 'info');

            const tests = [
                { name: 'Servidor', func: testServerStatus },
                { name: 'Login', func: performLogin },
                { name: 'Compra', func: simulatePurchase },
                { name: 'Permisos', func: checkPermissions },
                { name: 'Descarga', func: testDownload },
                { name: 'Base de datos', func: checkDatabase }
            ];

            let results = [];

            for (let test of tests) {
                try {
                    showResult('completeResult',
                        `üîÑ Ejecutando test: ${test.name}...\n` +
                        results.join('\n'), 'info');

                    await test.func();
                    results.push(`‚úÖ ${test.name}: OK`);

                    // Pausa entre tests
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    results.push(`‚ùå ${test.name}: ${error.message}`);
                }
            }

            showResult('completeResult',
                `üèÅ Test completo finalizado\n\n` +
                results.join('\n') + '\n\n' +
                `Total tests: ${tests.length}\n` +
                `Exitosos: ${results.filter(r => r.includes('‚úÖ')).length}\n` +
                `Fallidos: ${results.filter(r => r.includes('‚ùå')).length}`,
                results.every(r => r.includes('‚úÖ')) ? 'success' : 'error');
        }
    </script>
</body>
</html>
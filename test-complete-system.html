<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema Completo - ZIP Reales</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-download {
            background: #e74c3c;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #bee5eb;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .product-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .file-info {
            font-size: 11px;
            color: #666;
            margin: 5px 0;
        }
        .credentials {
            background: #e7f1ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test Sistema Completo - Archivos ZIP Reales</h1>

        <div class="credentials">
            <h3>üìã Credenciales de Prueba</h3>
            <p><strong>Email:</strong> demo@example.com</p>
            <p><strong>Password:</strong> 123456</p>
            <p><strong>Estado:</strong> <span id="auth-status">No logueado</span></p>
        </div>

        <!-- Login -->
        <div class="test-section">
            <h3>üîê Login</h3>
            <button class="btn" onclick="performLogin()">Login con demo@example.com</button>
            <div id="loginResult" class="result"></div>
        </div>

        <!-- Test Productos Actuales -->
        <div class="test-section">
            <h3>üìÅ Test URLs de Descarga - IDs Reales</h3>
            <div class="product-grid" id="productGrid"></div>
        </div>

        <!-- Simular Compra Nueva -->
        <div class="test-section">
            <h3>üõí Simular Nueva Compra</h3>
            <select id="newProductSelect">
                <option value="10">Windows 11 Pro</option>
                <option value="11">AutoCAD 2024</option>
                <option value="12">Minecraft Java Edition</option>
                <option value="14">Zoom Pro</option>
                <option value="15">Adobe Creative Suite</option>
                <option value="16">IntelliJ IDEA Ultimate</option>
                <option value="17">Spotify Premium</option>
                <option value="18">VMware Workstation Pro</option>
            </select>
            <button class="btn btn-success" onclick="simulateNewPurchase()">Simular Compra</button>
            <div id="newPurchaseResult" class="result"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let currentUser = null;

        // Productos con sus IDs reales
        const products = {
            7: { name: 'Microsoft Office 365', fileId: '1m3aB_q6ksXho6amul4a5Oy65Ju16EBsr' },
            8: { name: 'Adobe Photoshop', fileId: '1SYu0SUyB6tjewT9tCaU7A7JyjtN8s9pc' },
            9: { name: 'Visual Studio Code', fileId: '1D965qsRBXQr7GzIZtkQvtjUISzbliCpr' },
            10: { name: 'Windows 11 Pro', fileId: '1DQg743jbtuNYErgPAjSVHqJxOjLF_YvH' },
            11: { name: 'AutoCAD 2024', fileId: '1ZRYbmbbY2Ne_GhoHbV4VTUdcSMrgId_b' },
            12: { name: 'Minecraft Java Edition', fileId: '1Pjwh2MxMzLmp0N7DatNegPO3Y3GsXBik' },
            13: { name: 'Norton 360 Deluxe', fileId: '105ex1OkSehJTPZulzVb9Q9PANFpkCJLv' },
            14: { name: 'Zoom Pro', fileId: '1gN-9rwvJgT2OJ76XrSHi9hoPEiOojFpF' },
            15: { name: 'Adobe Creative Suite', fileId: '1jtXX8HdJR6tdbFoaeWmtAtDYdfha_OaE' },
            16: { name: 'IntelliJ IDEA Ultimate', fileId: '1yvONbmTRTQVgbi6nl2yeWqAnXW3katEf' },
            17: { name: 'Spotify Premium', fileId: '12_aeDM0Foh3dBS5vc8gg5Zl9Fsp1qgGD' },
            18: { name: 'VMware Workstation Pro', fileId: '1umpJtOWQ-WH059IcqvQLPtulFzS01hOV' }
        };

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }

        async function performLogin() {
            showResult('loginResult', 'Realizando login...', 'info');

            try {
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@example.com',
                        password: '123456'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.data.token;
                    currentUser = data.data.user;
                    document.getElementById('auth-status').textContent = `Logueado como ${currentUser.email}`;

                    showResult('loginResult', `‚úÖ Login exitoso\nUser: ${currentUser.email}\nID: ${currentUser.id}`, 'success');

                    // Cargar productos disponibles
                    loadUserProducts();
                } else {
                    throw new Error(data.error || 'Error en login');
                }
            } catch (error) {
                showResult('loginResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function loadUserProducts() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';

            // Solo mostrar productos para los que el usuario demo tiene permisos (producto 7)
            const userProducts = [7]; // Demo user solo tiene permiso para Office 365

            for (const productId of userProducts) {
                const product = products[productId];
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <h4>${product.name}</h4>
                    <div class="file-info">File ID: ${product.fileId}</div>
                    <div class="file-info">URL: https://drive.google.com/file/d/${product.fileId}/view</div>
                    <button class="btn btn-download" onclick="testDownload(${productId})">Descargar ZIP</button>
                    <div id="download-${productId}" class="result"></div>
                `;
                grid.appendChild(card);
            }
        }

        async function testDownload(productId) {
            if (!authToken) {
                showResult(`download-${productId}`, '‚ùå Debes hacer login primero', 'error');
                return;
            }

            showResult(`download-${productId}`, 'Obteniendo URL de descarga...', 'info');

            try {
                const response = await fetch('http://localhost:3000/api/purchases/get-download-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ productId: parseInt(productId) })
                });

                const data = await response.json();

                if (data.success) {
                    showResult(`download-${productId}`,
                        `‚úÖ URL obtenida:\n${data.downloadUrl}\n\nüîó Abriendo archivo...`, 'success');

                    // Abrir el archivo real de Google Drive
                    window.open(data.downloadUrl, '_blank');
                } else {
                    showResult(`download-${productId}`, `‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                showResult(`download-${productId}`, `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function simulateNewPurchase() {
            if (!authToken) {
                showResult('newPurchaseResult', '‚ùå Debes hacer login primero', 'error');
                return;
            }

            const productId = document.getElementById('newProductSelect').value;
            const productName = products[productId].name;

            showResult('newPurchaseResult', `Simulando compra de ${productName}...`, 'info');

            try {
                const response = await fetch('http://localhost:3000/api/purchases/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        productIds: [parseInt(productId)],
                        totalAmount: 99.99
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showResult('newPurchaseResult',
                        `‚úÖ Compra exitosa!\nOrder ID: ${data.orderId}\nProducto: ${productName}\n\nüîÑ Probando descarga inmediata...`, 'success');

                    // Probar descarga inmediata
                    setTimeout(() => testNewProductDownload(productId), 2000);
                } else {
                    throw new Error(data.error || 'Error en compra');
                }
            } catch (error) {
                showResult('newPurchaseResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testNewProductDownload(productId) {
            try {
                const response = await fetch('http://localhost:3000/api/purchases/get-download-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ productId: parseInt(productId) })
                });

                const data = await response.json();

                if (data.success) {
                    const product = products[productId];
                    showResult('newPurchaseResult',
                        `‚úÖ ¬°SISTEMA FUNCIONANDO PERFECTAMENTE!\n\n` +
                        `Producto: ${product.name}\n` +
                        `URL Real: ${data.downloadUrl}\n` +
                        `File ID: ${product.fileId}\n\n` +
                        `üéâ Archivo ZIP real abierto autom√°ticamente!`, 'success');

                    // Abrir el archivo real
                    window.open(data.downloadUrl, '_blank');
                } else {
                    showResult('newPurchaseResult',
                        `${document.getElementById('newPurchaseResult').textContent}\n\n‚ùå Error en descarga: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult('newPurchaseResult',
                    `${document.getElementById('newPurchaseResult').textContent}\n\n‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>